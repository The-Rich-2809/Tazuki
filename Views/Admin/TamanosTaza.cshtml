@{
    Layout = "_LayoutAdmin";
}
@using System.Data;
<div class="container mt-5">
    <h1 class="mb-4">Gestión de Tamaños de Tazas</h1>

    @if (ViewBag.ErrorMessage != null && ViewBag.ErrorMessage != "")
    {
        <div class="alert alert-danger" role="alert">
            @ViewBag.ErrorMessage
        </div>
    }

    <!-- Formulario para añadir nueva etiqueta -->
    <form asp-action="AgregarTamano" asp-controller="Admin" method="post">
        <div class="input-group mb-3">
            <input name="nombre" type="text" class="form-control" placeholder="Nombre" required>
            <button class="btn btn-primary" type="submit">Crear</button>
        </div>
    </form>

    <!-- Tabla para mostrar las etiquetas -->
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th scope="col">Nombre del Tamaño de Taza</th>
                <th scope="col" class="text-center">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (DataRow row_tag in ViewBag.Tags.Rows)
            {
                <tr data-id="@row_tag[0]">
                    <td>@row_tag[1]</td>
                    <td class="text-center">
                        <a href="#" class="btn btn-warning btn-sm me-2">Editar</a>
                        <a href="@Url.Action("Eliminar_Tamano", "Admin", new { Id = row_tag[0] })"
                           class="btn btn-danger btn-sm">Eliminar</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- JS de Bootstrap 5 (Bundle) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

<!-- Script para la funcionalidad de la tabla -->
<script>
    (function () {
      const tableBody = document.querySelector('.table tbody');
      if (!tableBody) return;

      tableBody.addEventListener('click', async (event) => {
        const btn = event.target.closest('.btn-warning, .btn-success');
        if (!btn) return;

        event.preventDefault();

        const row = btn.closest('tr');
        const cell = row.firstElementChild;
        const tagId = row.dataset.id;

        // --- MODO EDITAR ---
        if (btn.classList.contains('btn-warning')) {
          const originalName = cell.textContent.trim();

          const input = document.createElement('input');
          input.type = 'text';
          input.className = 'form-control';
          input.value = originalName;

          cell.dataset.originalName = originalName;
          cell.textContent = '';
          cell.appendChild(input);
          input.focus();

          btn.textContent = 'Guardar';
          btn.classList.remove('btn-warning');
          btn.classList.add('btn-success');
          return;
        }

        // --- MODO GUARDAR ---
        if (btn.classList.contains('btn-success')) {
          const input = cell.querySelector('input');
          const originalName = cell.dataset.originalName || '';
          const newName = input ? input.value.trim() : originalName;

          if (newName === originalName) {
            cell.textContent = originalName;
            btn.textContent = 'Editar';
            btn.classList.remove('btn-success');
            btn.classList.add('btn-warning');
            return;
          }

          const data = { Id: parseInt(tagId), Nombre: newName };

          try {
            const response = await fetch('@Url.Action("ModTamano", "Admin")', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(data)
            });

            if (response.ok) {
              cell.textContent = newName;
              btn.textContent = 'Editar';
              btn.classList.remove('btn-success');
              btn.classList.add('btn-warning');
            } else {
              alert('Error al guardar la etiqueta.');
              cell.textContent = originalName;
              btn.textContent = 'Editar';
              btn.classList.remove('btn-success');
              btn.classList.add('btn-warning');
            }
          } catch (err) {
            console.error('Error en fetch:', err);
            alert('Hubo un problema de conexión.');
            cell.textContent = originalName;
            btn.textContent = 'Editar';
            btn.classList.remove('btn-success');
            btn.classList.add('btn-warning');
          }
        }
      });
    })();
</script>
